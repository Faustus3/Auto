<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director's Script Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Linke Spalte - The Bible */
        .bible-panel {
            width: 25%;
            background: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        .bible-panel::-webkit-scrollbar {
            width: 8px;
        }

        .bible-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .bible-panel::-webkit-scrollbar-thumb {
            background: #8b9dc3;
            border-radius: 4px;
        }

        .bible-panel::-webkit-scrollbar-thumb:hover {
            background: #c73e1d;
        }

        .bible-panel.collapsed {
            width: 60px;
            padding: 10px;
            overflow: hidden;
        }

        .bible-panel.collapsed h2,
        .bible-panel.collapsed .bible-section,
        .bible-panel.collapsed .add-character-btn {
            display: none;
        }

        .bible-panel h2 {
            color: #8b9dc3;
            font-size: 18px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .bible-section {
            margin-bottom: 25px;
        }

        .bible-section h3 {
            color: #a0a0a0;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .bible-textarea {
            width: 100%;
            min-height: 120px;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #c0c0c0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .bible-textarea:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        /* Character Cards */
        .character-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .character-cards::-webkit-scrollbar {
            width: 6px;
        }

        .character-cards::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .character-cards::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .character-card {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .character-card.editing {
            border-color: #8b9dc3;
            background: #1a2a3a;
        }

        .character-card:hover {
            border-color: #8b9dc3;
            transform: translateY(-1px);
        }

        .character-card.expanded {
            background: #1a1a1a;
            border-color: #8b9dc3;
        }

        .character-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .character-name {
            font-size: 14px;
            font-weight: bold;
            color: #8b9dc3;
        }

        .character-role {
            font-size: 11px;
            color: #a0a0a0;
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
        }

        .character-summary {
            font-size: 12px;
            color: #c0c0c0;
            line-height: 1.4;
        }

        .character-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }

        .character-card.expanded .character-details {
            display: block;
        }

        .character-detail-item {
            margin-bottom: 8px;
        }

        .character-detail-label {
            font-size: 11px;
            color: #a0a0a0;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .character-detail-value {
            font-size: 12px;
            color: #e0e0e0;
            line-height: 1.4;
        }

        .character-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 5px;
        }

        .character-card:hover .character-actions {
            display: flex;
        }

        .character-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px;
            font-size: 10px;
            transition: color 0.2s;
        }

        .character-action-btn:hover {
            color: #c73e1d;
        }

        .character-edit-btn:hover {
            color: #8b9dc3;
        }

        .add-character-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            margin-bottom: 15px;
        }

        .add-character-btn:hover {
            background: #8b9dc3;
            border-color: #8b9dc3;
        }

        /* Mittlere Spalte - The Script */
        .script-panel {
            width: 50%;
            background: #0f0f0f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .script-panel.expanded {
            width: 80%;
        }

        .script-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
        }

        .script-header h2 {
            color: #c73e1d;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .script-editor {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .script-editor::-webkit-scrollbar {
            width: 10px;
        }

        .script-editor::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        .script-editor::-webkit-scrollbar-thumb {
            background: #c73e1d;
            border-radius: 5px;
        }

        .script-editor::-webkit-scrollbar-thumb:hover {
            background: #d84e2d;
        }

        .script-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        .script-textarea:focus {
            outline: none;
        }

        /* Rechte Spalte - The Dramaturg */
        .dramaturg-panel {
            width: 25%;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .dramaturg-panel::-webkit-scrollbar {
            width: 8px;
        }

        .dramaturg-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .dramaturg-panel::-webkit-scrollbar-thumb {
            background: #8b9dc3;
            border-radius: 4px;
        }

        .dramaturg-panel::-webkit-scrollbar-thumb:hover {
            background: #c73e1d;
        }

        .dramaturg-panel.expanded {
            width: 40%;
        }

        .dramaturg-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .dramaturg-header h2 {
            color: #8b9dc3;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .ollama-config {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .ollama-url-input {
            flex: 1;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 5px 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
        }

        .ollama-url-input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .ollama-save-btn {
            background: #4a9d4a;
            border: none;
            color: white;
            padding: 5px 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ollama-save-btn:hover {
            background: #5aad5a;
        }

        .smart-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 20px 20px;
        }

        .action-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 12px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:hover {
            background: #c73e1d;
            border-color: #c73e1d;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 4px;
            min-height: 200px;
            max-height: 50vh;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #8b9dc3;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #c73e1d;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
        }

        .user-message {
            background: #2a2a2a;
            border-left: 3px solid #8b9dc3;
        }

        .ai-message {
            background: #1a3a2a;
            border-left: 3px solid #4a9d4a;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .send-btn {
            background: #c73e1d;
            border: none;
            color: white;
            padding: 10px 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .send-btn:hover {
            background: #d84e2d;
        }

        .export-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            margin: 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-btn:hover {
            background: #8b9dc3;
            border-color: #8b9dc3;
        }

        /* Upload Button */
        .upload-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            margin: 0 20px 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: calc(100% - 40px);
        }

        .upload-btn:hover {
            background: #4a6a4a;
            border-color: #4a6a4a;
        }

        /* File Input (versteckt) */
        .file-input {
            display: none;
        }

        /* Upload Status */
        .upload-status {
            padding: 10px;
            margin: 0 20px 20px;
            background: #1a3a2a;
            border: 1px solid #4a9d4a;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .upload-status.success {
            background: #1a3a2a;
            border-color: #4a9d4a;
            color: #e0e0e0;
        }

        .upload-status.error {
            background: #3a1a1a;
            border-color: #c73e1d;
            color: #e0e0e0;
        }

        /* Upload Progress */
        .upload-progress {
            padding: 10px;
            margin: 0 20px 20px;
            background: #1a2a3a;
            border: 1px solid #8b9dc3;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #0f0f0f;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #8b9dc3;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Linke Spalte - The Bible -->
        <div class="bible-panel">
            <h2>The Bible</h2>
            
            <div class="bible-section">
                <h3>Charaktere</h3>
                <button class="add-character-btn" id="addCharacterBtn">Neuer Charakter</button>
                <div class="character-cards" id="characterCards"></div>
            </div>
            
            <div class="bible-section">
                <h3>Drehorte</h3>
                <textarea class="bible-textarea" id="locations" placeholder="ORT&#10;Beschreibung:&#10;Atmosphäre:&#10;Bedeutung:"></textarea>
            </div>
            
            <div class="bible-section">
                <h3>Hintergründe</h3>
                <textarea class="bible-textarea" id="background" placeholder="WELT/ZEIT&#10;Regeln:&#10;Konflikte:&#10;Themen:"></textarea>
            </div>
        </div>
        
        <!-- Mittlere Spalte - The Script -->
        <div class="script-panel">
            <div class="script-header">
                <h2>The Script</h2>
            </div>
            <div class="script-editor">
                <textarea class="script-textarea" id="script" placeholder="FADE IN:

EXT. ORT - TAG

Eine Beschreibung der Szene.

                        CHARAKTER
            Dialogtext hier.

                        ANDERER CHARAKTER
            Antwort hier.

FADE OUT."></textarea>
            </div>
        </div>
        
        <!-- Rechte Spalte - The Dramaturg -->
        <div class="dramaturg-panel">
            <div class="dramaturg-header">
                <h2>Directorial Notes</h2>
                <div class="ollama-config">
                    <input type="text" class="ollama-url-input" id="ollamaUrlInput" placeholder="Ollama URL">
                    <button class="ollama-save-btn" id="saveOllamaUrl">Speichern</button>
                </div>
            </div>
            
            <div class="smart-actions">
                <button class="action-btn" id="analyzeScene">Szene analysieren</button>
                <button class="action-btn" id="dialogCheck">Dialog-Check</button>
                <button class="action-btn" id="continueWriting">Weiterschreiben</button>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        Willkommen bei der Director's Script Engine. Ich bin Ihr Script-Consultant und helfe Ihnen bei der Entwicklung Ihres Drehbuchs. Stellen Sie mir Fragen oder nutzen Sie die Smart Actions für gezielte Analysen.
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Frage an den Dramaturgen...">
                    <button class="send-btn" id="sendMessageBtn">Senden</button>
                </div>
            </div>
            
            <button class="export-btn" id="exportBtn">Arbeit exportieren</button>
            
            <!-- Upload Section -->
            <input type="file" class="file-input" id="fileInput" accept=".json,.txt,.doc,.docx">
            <button class="upload-btn" id="uploadBtn">Knowledge Base importieren (.json, .txt, .doc, .docx)</button>
            <div class="upload-progress" id="uploadProgress">
                <div>Konvertierung läuft...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="upload-status" id="uploadStatus"></div>
        </div>
    </div>

    <script>
        // IndexedDB für Datenpersistenz
        const DB_NAME = 'DirectorsScriptEngine';
        const DB_VERSION = 1;
        let db;
        let characters = []; // Array für Charakter-Kacheln

        // IndexedDB initialisieren
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('scriptData')) {
                        db.createObjectStore('scriptData');
                    }
                };
            });
        }

        // Daten speichern
        async function saveData(key, data) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['scriptData'], 'readwrite');
                const store = transaction.objectStore('scriptData');
                const request = store.put(data, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Daten laden
        async function loadData(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['scriptData'], 'readonly');
                const store = transaction.objectStore('scriptData');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Alle Daten laden
        async function loadAllData() {
            const locations = await loadData('locations') || '';
            const background = await loadData('background') || '';
            const script = await loadData('script') || '';

            // Sicherheitsprüfungen für DOM-Elemente
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');
            const scriptElement = document.getElementById('script');

            if (locationsElement) locationsElement.value = locations;
            if (backgroundElement) backgroundElement.value = background;
            if (scriptElement) scriptElement.value = script;

            // Charakter-Kacheln laden (ersetzt das alte characters textarea)
            await loadCharacters();
        }

        // Charakter-Kacheln laden
        async function loadCharacters() {
            const savedCharacters = await loadData('characterCards') || [];
            characters = Array.isArray(savedCharacters) ? savedCharacters : [];
            renderAllCharacters();
        }

        // Charakter-Kacheln speichern
        async function saveCharacters() {
            await saveData('characterCards', characters);
        }

        // Charakter-Kachel erstellen
        function createCharacterCard(character, index) {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.dataset.index = index;

            card.innerHTML = `
                <div class="character-card-header">
                    <div class="character-name">${character.name}</div>
                    <div class="character-role">${character.role || 'Charakter'}</div>
                </div>
                <div class="character-summary">${character.summary || 'Keine Zusammenfassung verfügbar.'}</div>
                <div class="character-details">
                    <div class="character-detail-item">
                        <div class="character-detail-label">Alter</div>
                        <div class="character-detail-value">${character.age || 'Unbekannt'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Aussehen</div>
                        <div class="character-detail-value">${character.appearance || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Persönlichkeit</div>
                        <div class="character-detail-value">${character.personality || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Motivation</div>
                        <div class="character-detail-value">${character.motivation || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Hintergrund</div>
                        <div class="character-detail-value">${character.background || 'Nicht beschrieben'}</div>
                    </div>
                </div>
                <div class="character-actions">
                    <button class="character-action-btn" onclick="deleteCharacter(${index})">×</button>
                </div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('character-action-btn')) {
                    toggleCharacterCard(card);
                }
            });

            return card;
        }

        // Alle Charakter-Kacheln rendern
        function renderAllCharacters() {
            const container = document.getElementById('characterCards');
            container.innerHTML = '';

            characters.forEach((character, index) => {
                const card = createCharacterCard(character, index);
                container.appendChild(card);
            });
        }

        // Charakter-Kachel expandieren/collapsen
        function toggleCharacterCard(card) {
            card.classList.toggle('expanded');
        }

        // Neuen Charakter hinzufügen
        function addCharacter(characterData = null) {
            const newCharacter = characterData || {
                name: 'Neuer Charakter',
                role: 'Charakter',
                age: '',
                appearance: '',
                personality: '',
                motivation: '',
                background: '',
                summary: 'Neuer Charakter ohne Beschreibung.'
            };

            characters.push(newCharacter);
            saveCharacters();
            renderAllCharacters();
        }

        // Charakter löschen
        window.deleteCharacter = function(index) {
            if (confirm('Charakter wirklich löschen?')) {
                characters.splice(index, 1);
                saveCharacters();
                renderAllCharacters();
            }
        };

        // Ollama-Antwort für Charakter parsen - Robuster Parser
        function parseCharacterFromResponse(response, requestedName = '') {
            console.log('Parsing response:', response);

            const character = {
                name: requestedName || 'Unbenannter Charakter',
                role: 'Charakter',
                age: '',
                appearance: '',
                personality: '',
                motivation: '',
                background: '',
                summary: ''
            };

            // Versuche verschiedene Parsing-Strategien

            // Strategie 1: Nach Schlüsselwörtern suchen (case-insensitive)
            const lines = response.split('\n').map(line => line.trim()).filter(line => line);

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();

                // Name finden
                if (lowerLine.includes('name:') || (lowerLine.includes('name') && !lowerLine.includes('filename'))) {
                    const match = line.match(/name:?\s*(.+)/i);
                    if (match) character.name = match[1].trim();
                }

                // Alter finden
                if (lowerLine.includes('alter:') || lowerLine.includes('age:')) {
                    const match = line.match(/(alter|age):?\s*(.+)/i);
                    if (match) character.age = match[2].trim();
                }

                // Aussehen finden
                if (lowerLine.includes('aussehen:') || lowerLine.includes('appearance:')) {
                    const match = line.match(/(aussehen|appearance):?\s*(.+)/i);
                    if (match) character.appearance = match[2].trim();
                }

                // Persönlichkeit finden
                if (lowerLine.includes('persönlichkeit:') || lowerLine.includes('personality:')) {
                    const match = line.match(/(persönlichkeit|personality):?\s*(.+)/i);
                    if (match) character.personality = match[2].trim();
                }

                // Motivation finden
                if (lowerLine.includes('motivation:')) {
                    const match = line.match(/motivation:?\s*(.+)/i);
                    if (match) character.motivation = match[2].trim();
                }

                // Hintergrund finden
                if (lowerLine.includes('hintergrund:') || lowerLine.includes('background:')) {
                    const match = line.match(/(hintergrund|background):?\s*(.+)/i);
                    if (match) character.background = match[2].trim();
                }

                // Rolle finden
                if (lowerLine.includes('rolle:') || lowerLine.includes('role:')) {
                    const match = line.match(/(rolle|role):?\s*(.+)/i);
                    if (match) character.role = match[2].trim();
                }
            });

            // Strategie 2: Fallback - wenn keine strukturierten Daten gefunden wurden,
            // verwende die gesamte Antwort als Hintergrund
            if (!character.appearance && !character.personality && !character.motivation && !character.background) {
                // Extrahiere sinnvolle Informationen aus der freien Antwort
                const sentences = response.split(/[.!?]+/).filter(s => s.trim().length > 10);
                if (sentences.length > 0) {
                    character.background = sentences.slice(0, 2).join('. ').trim();
                    character.personality = sentences.length > 2 ? sentences[2] : 'Nicht spezifiziert';
                }
            }

            // Zusammenfassung erstellen
            const ageInfo = character.age ? `${character.age} Jahre alt` : 'Alter unbekannt';
            const personalityInfo = character.personality ? character.personality : 'Persönlichkeit nicht beschrieben';
            character.summary = `${character.name} ist ${ageInfo}. ${personalityInfo}`;

            console.log('Parsed character:', character);
            return character;
        }

        // Auto-Save Funktion
        function setupAutoSave() {
            const elements = ['locations', 'background', 'script'];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        saveData(id, element.value);
                    });
                }
            });
        }

        // Ollama API Call - Konfigurierbare URL für lokale/dev und remote/production
        async function callOllama(prompt, context) {
            // URL konfigurierbar machen - standardmäßig localhost für Entwicklung
            const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434/api/generate';

            try {
                const response = await fetch(ollamaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama3.2',
                        prompt: `${context}\n\n${prompt}`,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Debug: Log the response to see its structure
                console.log('Ollama Response:', data);

                // Check if response exists and has the correct property
                if (data && data.response) {
                    return data.response;
                } else if (data && data.text) {
                    return data.text;
                } else if (data && typeof data === 'string') {
                    return data;
                } else {
                    console.error('Unexpected response format:', data);
                    return 'Unerwartetes Antwortformat von Ollama';
                }
            } catch (error) {
                console.error('Ollama API Error:', error);

                // Spezifische CORS/HTTPS-Fehlerbehandlung
                if (error.message.includes('CORS') || error.message.includes('Mixed Content')) {
                    return `CORS-Fehler: Die Website (HTTPS) kann nicht auf lokales Ollama (HTTP) zugreifen.\n\nLösungen:\n1. Ollama mit CORS starten: OLLAMA_ORIGINS=https://sohaltweil.de ollama serve\n2. Ollama auf HTTPS-Server hosten\n3. Browser-Einstellungen anpassen (unsichere Inhalte erlauben)\n\nTechnischer Fehler: ${error.message}`;
                }

                return `Fehler bei der Verbindung zu Ollama: ${error.message}\n\nStellen Sie sicher, dass:\n- Ollama läuft (${ollamaUrl})\n- Das Modell 'llama3.2' verfügbar ist\n- CORS für diese Domain erlaubt ist`;
            }
        }

        // Nachricht zum Chat hinzufügen
        function addMessage(text, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Smart Actions - Sicherheitsprüfungen für DOM-Elemente
        document.getElementById('analyzeScene').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');
            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';

            const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

            addMessage('Analysiere Szene...', true);

            const prompt = 'Analysiere diese Szene auf Pacing, Spannungsbogen und Subtext. Gib konstruktive Hinweise für die Regie.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        document.getElementById('dialogCheck').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');

            const context = `CHARACTERS:\n${charactersText}\n\nSCRIPT:\n${script}`;

            addMessage('Prüfe Dialoge...', true);

            const prompt = 'Prüfe, ob die Dialoge der Charaktere konsistent mit ihren beschriebenen Persönlichkeiten sind. Gib spezifische Hinweise für jeden Charakter.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        document.getElementById('continueWriting').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');
            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';

            const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

            addMessage('Schreibe weiter...', true);

            const prompt = 'Schlage die nächsten 5-10 Zeilen des Drehbuchs vor, die sich nahtlos an die letzte Szene anschließen. Halte dich an das Format und die Charaktere.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        // Chat-Funktionalität
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';

            // Prüfe auf Charakter-Erstellungsbefehle
            const characterMatch = message.match(/(erstelle|create).*steckbrief.*für\s+(.+)/i) ||
                                   message.match(/(erstelle|create).*(charakter|character).*\s+(.+)/i);

            if (characterMatch) {
                const characterName = characterMatch[2].trim();
                addMessage(`Erstelle Steckbrief für ${characterName}...`, false);

                const script = document.getElementById('script').value;
                const context = `SCRIPT:\n${script}\n\nErstelle einen detaillierten Steckbrief für den Charakter "${characterName}". Gib die Informationen in folgendem Format zurück:\n\nName: ${characterName}\nAlter: [z.B. 25]\nAussehen: [detaillierte Beschreibung]\nPersönlichkeit: [z.B. introvertiert, ehrgeizig]\nMotivation: [Hauptziele und Antriebe]\nHintergrund: [kurze Lebensgeschichte]\nRolle: [Protagonist/Antagonist/Nebenfigur]`;

                try {
                    const response = await callOllama(`Erstelle einen strukturierten Steckbrief für den Charakter "${characterName}" basierend auf dem Skript. Antworte nur mit den formatierten Informationen, keine zusätzlichen Kommentare.`, context);
                    addMessage(`Steckbrief für ${characterName} erstellt!`, false);

                    // Parse die Antwort und erstelle eine Charakter-Kachel
                    const characterData = parseCharacterFromResponse(response, characterName);
                    addCharacter(characterData);

                    addMessage(`Charakter "${characterName}" wurde zur Bible hinzugefügt.`, false);
                } catch (error) {
                    addMessage(`Fehler beim Erstellen des Steckbriefs: ${error.message}`, false);
                }
            } else {
                // Normale Chat-Funktionalität
                const scriptElement = document.getElementById('script');
                const locationsElement = document.getElementById('locations');
                const backgroundElement = document.getElementById('background');

                const script = scriptElement ? scriptElement.value : '';
                // Verwende Charakter-Kacheln statt textarea
                const charactersText = characters.map(char =>
                    `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
                ).join('\n\n');
                const locations = locationsElement ? locationsElement.value : '';
                const background = backgroundElement ? backgroundElement.value : '';

                const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

                const response = await callOllama(message, context);
                addMessage(response);
            }
        });

        // Enter-Taste für Chat
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Export-Funktion
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');
            const scriptElement = document.getElementById('script');

            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';
            const script = scriptElement ? scriptElement.value : '';

            const exportData = {
                characterCards: characters, // Neue Charakter-Kacheln
                locations: locations,
                background: background,
                script: script,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `script-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            addMessage('Arbeit wurde als JSON exportiert.', false);
        });

        // Ollama URL Konfiguration
        document.getElementById('saveOllamaUrl').addEventListener('click', () => {
            const url = document.getElementById('ollamaUrlInput').value.trim();
            if (url) {
                localStorage.setItem('ollamaUrl', url);
                addMessage(`Ollama URL gespeichert: ${url}`, false);
                document.getElementById('ollamaUrlInput').value = '';
            } else {
                addMessage('Bitte geben Sie eine gültige URL ein.', false);
            }
        });

        // Neuer Charakter Button
        document.getElementById('addCharacterBtn').addEventListener('click', () => {
            console.log('Neuer Charakter Button geklickt');
            addCharacter();
            addMessage('Neuer Charakter wurde zur Bible hinzugefügt.', false);
        });

        // Memory Bank Status überprüfen
        async function checkMemoryBank() {
            const memoryStatus = {
                characters: characters.length,
                locations: (await loadData('locations') || '').length,
                background: (await loadData('background') || '').length,
                script: (await loadData('script') || '').length,
                totalEntries: 0
            };

            memoryStatus.totalEntries = memoryStatus.characters +
                                       (memoryStatus.locations > 0 ? 1 : 0) +
                                       (memoryStatus.background > 0 ? 1 : 0) +
                                       (memoryStatus.script > 0 ? 1 : 0);

            console.log('Memory Bank Status:', memoryStatus);
            addMessage(`Memory Bank: ${memoryStatus.characters} Charaktere, ${memoryStatus.totalEntries} Einträge gespeichert.`, false);

            return memoryStatus;
        }

        // Auto-Expand Funktion für Panels basierend auf Cursor-Position
        function setupAutoExpand() {
            const container = document.querySelector('.container');
            const biblePanel = document.querySelector('.bible-panel');
            const scriptPanel = document.querySelector('.script-panel');
            const dramaturgPanel = document.querySelector('.dramaturg-panel');

            let isMouseInside = false;
            let mouseX = 0;

            container.addEventListener('mouseenter', () => {
                isMouseInside = true;
            });

            container.addEventListener('mouseleave', () => {
                isMouseInside = false;
                // Reset all panels to normal size
                biblePanel.classList.remove('collapsed');
                scriptPanel.classList.remove('expanded');
                dramaturgPanel.classList.remove('expanded');
            });

            container.addEventListener('mousemove', (e) => {
                if (!isMouseInside) return;

                mouseX = e.clientX;
                const containerWidth = container.offsetWidth;
                const relativeX = mouseX / containerWidth;

                // Reset all panels first
                biblePanel.classList.remove('collapsed');
                scriptPanel.classList.remove('expanded');
                dramaturgPanel.classList.remove('expanded');

                // Expand panels based on cursor position
                if (relativeX < 0.25) {
                    // Cursor in left third - expand Bible
                    biblePanel.classList.remove('collapsed');
                    scriptPanel.classList.remove('expanded');
                    dramaturgPanel.classList.remove('expanded');
                } else if (relativeX < 0.75) {
                    // Cursor in middle third - expand Script
                    biblePanel.classList.add('collapsed');
                    scriptPanel.classList.add('expanded');
                    dramaturgPanel.classList.remove('expanded');
                } else {
                    // Cursor in right third - expand Dramaturg
                    biblePanel.classList.add('collapsed');
                    scriptPanel.classList.remove('expanded');
                    dramaturgPanel.classList.add('expanded');
                }
            });
        }

        // Verbesserte Chat-Funktionalität mit Hintergrundinfos
        function enhanceChat() {
            const chatInput = document.getElementById('chatInput');
            
            // Platzhalter mit erweiterten Vorschlägen
            const placeholders = [
                'Frage an den Dramaturgen...',
                'Frage zu Charakteren, Orten oder Hintergründen...',
                'Bitte analysiere die aktuelle Szene...',
                'Wie kann ich den Dialog verbessern?...',
                'Erstelle einen Steckbrief für [Charaktername]...'
            ];
            
            let placeholderIndex = 0;
            chatInput.placeholder = placeholders[placeholderIndex];
            
            // Platzhalter rotieren alle 5 Sekunden
            setInterval(() => {
                placeholderIndex = (placeholderIndex + 1) % placeholders.length;
                if (!chatInput.matches(':focus')) {
                    chatInput.placeholder = placeholders[placeholderIndex];
                }
            }, 5000);
        }

        // Upload-Funktion für Knowledge Base mit erweiterter Unterstützung
        function setupUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');

            // Upload Button klicken löst File Input aus
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            // File Input ändert sich
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Unterstützte Dateiformate
                const supportedFormats = ['.json', '.txt', '.doc', '.docx'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

                if (!supportedFormats.includes(fileExtension)) {
                    showUploadStatus(`Nur ${supportedFormats.join(', ')} Dateien sind erlaubt!`, 'error');
                    return;
                }

                try {
                    // Fortschrittsanzeige anzeigen
                    uploadProgress.style.display = 'block';
                    uploadStatus.style.display = 'none';
                    updateProgress(10);

                    let data;

                    if (fileExtension === '.json') {
                        // JSON-Datei direkt verarbeiten
                        updateProgress(30);
                        const text = await file.text();
                        updateProgress(60);
                        data = JSON.parse(text);
                        updateProgress(80);

                        // Datenvalidierung
                        if (!validateImportData(data)) {
                            showUploadStatus('Ungültiges JSON-Format!', 'error');
                            uploadProgress.style.display = 'none';
                            return;
                        }
                    } else {
                        // Text- oder Word-Datei konvertieren
                        updateProgress(20);
                        const text = await readTextFile(file, fileExtension);
                        updateProgress(50);
                        data = await convertTextToStructure(text);
                        updateProgress(80);
                    }

                    // Daten importieren
                    await importData(data);
                    updateProgress(100);

                    showUploadStatus('Knowledge Base erfolgreich importiert!', 'success');
                    addMessage('Knowledge Base wurde erfolgreich importiert und konvertiert.', false);

                } catch (error) {
                    console.error('Upload error:', error);
                    showUploadStatus(`Fehler beim Import: ${error.message}`, 'error');
                } finally {
                    // Fortschrittsanzeige ausblenden
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 1000);
                }
            });
        }

        // Textdatei lesen (TXT, DOC, DOCX)
        async function readTextFile(file, extension) {
            if (extension === '.txt') {
                return await file.text();
            } else if (extension === '.doc' || extension === '.docx') {
                // Für DOC/DOCX verwenden wir eine einfache Text-Extraktion
                // In einer realen Anwendung würde man hier eine Bibliothek wie mammoth.js verwenden
                return await file.text();
            }
        }

        // Text in strukturierte Daten konvertieren
        async function convertTextToStructure(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            const data = {
                characterCards: [],
                locations: '',
                background: '',
                script: ''
            };

            let currentSection = null;
            let sectionContent = [];

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();

                // Sektionen erkennen
                if (lowerLine.includes('charaktere') || lowerLine.includes('characters')) {
                    if (currentSection && sectionContent.length > 0) {
                        saveSection(currentSection, sectionContent.join('\n'), data);
                    }
                    currentSection = 'characters';
                    sectionContent = [];
                } else if (lowerLine.includes('drehorte') || lowerLine.includes('locations') || lowerLine.includes('orte')) {
                    if (currentSection && sectionContent.length > 0) {
                        saveSection(currentSection, sectionContent.join('\n'), data);
                    }
                    currentSection = 'locations';
                    sectionContent = [];
                } else if (lowerLine.includes('hintergrund') || lowerLine.includes('background') || lowerLine.includes('welt')) {
                    if (currentSection && sectionContent.length > 0) {
                        saveSection(currentSection, sectionContent.join('\n'), data);
                    }
                    currentSection = 'background';
                    sectionContent = [];
                } else if (lowerLine.includes('script') || lowerLine.includes('drehbuch') || lowerLine.includes('szene')) {
                    if (currentSection && sectionContent.length > 0) {
                        saveSection(currentSection, sectionContent.join('\n'), data);
                    }
                    currentSection = 'script';
                    sectionContent = [];
                } else {
                    sectionContent.push(line);
                }
            });

            // Letzte Sektion speichern
            if (currentSection && sectionContent.length > 0) {
                saveSection(currentSection, sectionContent.join('\n'), data);
            }

            return data;
        }

        // Sektion speichern
        function saveSection(section, content, data) {
            switch (section) {
                case 'characters':
                    // Charaktere aus Text extrahieren
                    const characterBlocks = content.split(/\n\s*\n/);
                    characterBlocks.forEach(block => {
                        if (block.trim()) {
                            const character = parseCharacterFromText(block);
                            if (character.name) {
                                data.characterCards.push(character);
                            }
                        }
                    });
                    break;
                case 'locations':
                    data.locations = content;
                    break;
                case 'background':
                    data.background = content;
                    break;
                case 'script':
                    data.script = content;
                    break;
            }
        }

        // Charakter aus Text parsen
        function parseCharacterFromText(text) {
            const character = {
                name: 'Unbekannter Charakter',
                role: 'Charakter',
                age: '',
                appearance: '',
                personality: '',
                motivation: '',
                background: '',
                summary: ''
            };

            const lines = text.split('\n');
            let firstLine = true;

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();

                if (firstLine) {
                    character.name = line.trim();
                    firstLine = false;
                }

                // Versuche, Informationen aus der Zeile zu extrahieren
                if (lowerLine.includes('alter:') || lowerLine.includes('age:')) {
                    character.age = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('aussehen:') || lowerLine.includes('appearance:')) {
                    character.appearance = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('persönlichkeit:') || lowerLine.includes('personality:')) {
                    character.personality = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('motivation:')) {
                    character.motivation = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('hintergrund:') || lowerLine.includes('background:')) {
                    character.background = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('rolle:') || lowerLine.includes('role:')) {
                    character.role = line.split(':')[1]?.trim() || 'Charakter';
                }
            });

            // Zusammenfassung erstellen
            const ageInfo = character.age ? `${character.age} Jahre alt` : 'Alter unbekannt';
            const personalityInfo = character.personality ? character.personality : 'Persönlichkeit nicht beschrieben';
            character.summary = `${character.name} ist ${ageInfo}. ${personalityInfo}`;

            return character;
        }

        // Fortschrittsanzeige aktualisieren
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percent}%`;
        }

        // Datenvalidierung für Import
        function validateImportData(data) {
            if (typeof data !== 'object' || data === null) {
                return false;
            }

            // Prüfe, ob mindestens ein erwartetes Feld vorhanden ist
            const validFields = ['characterCards', 'locations', 'background', 'script'];
            return validFields.some(field => data.hasOwnProperty(field));
        }

        // Daten importieren
        async function importData(data) {
            // Charaktere importieren
            if (Array.isArray(data.characterCards)) {
                characters = data.characterCards;
                await saveCharacters();
                renderAllCharacters();
            }

            // Locations importieren
            if (typeof data.locations === 'string') {
                document.getElementById('locations').value = data.locations;
                await saveData('locations', data.locations);
            }

            // Background importieren
            if (typeof data.background === 'string') {
                document.getElementById('background').value = data.background;
                await saveData('background', data.background);
            }

            // Script importieren
            if (typeof data.script === 'string') {
                document.getElementById('script').value = data.script;
                await saveData('script', data.script);
            }
        }

        // Upload-Status anzeigen
        function showUploadStatus(message, type) {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';

            // Status nach 5 Sekunden ausblenden
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 5000);
        }

        // URL Eingabe beim Laden mit aktueller URL füllen
        window.addEventListener('load', async () => {
            await initDB();
            await loadAllData();
            setupAutoSave();
            setupAutoExpand();
            enhanceChat();
            setupUpload();

            // Aktuelle Ollama URL anzeigen
            const currentUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434/api/generate';
            document.getElementById('ollamaUrlInput').placeholder = `Aktuell: ${currentUrl}`;

            // Memory Bank Status nach dem Laden überprüfen
            setTimeout(checkMemoryBank, 1000);
        });
    </script>
</body>
</html>

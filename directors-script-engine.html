<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director's Script Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Linke Spalte - The Bible */
        .bible-panel {
            width: 25%;
            background: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .bible-panel h2 {
            color: #8b9dc3;
            font-size: 18px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .bible-section {
            margin-bottom: 25px;
        }

        .bible-section h3 {
            color: #a0a0a0;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .bible-textarea {
            width: 100%;
            min-height: 120px;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #c0c0c0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .bible-textarea:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        /* Character Cards */
        .character-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .character-cards::-webkit-scrollbar {
            width: 6px;
        }

        .character-cards::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .character-cards::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .character-card {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .character-card:hover {
            border-color: #8b9dc3;
            transform: translateY(-1px);
        }

        .character-card.expanded {
            background: #1a1a1a;
            border-color: #8b9dc3;
        }

        .character-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .character-name {
            font-size: 14px;
            font-weight: bold;
            color: #8b9dc3;
        }

        .character-role {
            font-size: 11px;
            color: #a0a0a0;
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
        }

        .character-summary {
            font-size: 12px;
            color: #c0c0c0;
            line-height: 1.4;
        }

        .character-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }

        .character-card.expanded .character-details {
            display: block;
        }

        .character-detail-item {
            margin-bottom: 8px;
        }

        .character-detail-label {
            font-size: 11px;
            color: #a0a0a0;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .character-detail-value {
            font-size: 12px;
            color: #e0e0e0;
            line-height: 1.4;
        }

        .character-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 5px;
        }

        .character-card:hover .character-actions {
            display: flex;
        }

        .character-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px;
            font-size: 10px;
            transition: color 0.2s;
        }

        .character-action-btn:hover {
            color: #c73e1d;
        }

        .add-character-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            margin-bottom: 15px;
        }

        .add-character-btn:hover {
            background: #8b9dc3;
            border-color: #8b9dc3;
        }

        /* Mittlere Spalte - The Script */
        .script-panel {
            width: 50%;
            background: #0f0f0f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .script-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
        }

        .script-header h2 {
            color: #c73e1d;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .script-editor {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .script-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        .script-textarea:focus {
            outline: none;
        }

        /* Rechte Spalte - The Dramaturg */
        .dramaturg-panel {
            width: 25%;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
        }

        .dramaturg-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .dramaturg-header h2 {
            color: #8b9dc3;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .ollama-config {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .ollama-url-input {
            flex: 1;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 5px 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
        }

        .ollama-url-input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .ollama-save-btn {
            background: #4a9d4a;
            border: none;
            color: white;
            padding: 5px 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ollama-save-btn:hover {
            background: #5aad5a;
        }

        .smart-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 20px 20px;
        }

        .action-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 12px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:hover {
            background: #c73e1d;
            border-color: #c73e1d;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 4px;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
        }

        .user-message {
            background: #2a2a2a;
            border-left: 3px solid #8b9dc3;
        }

        .ai-message {
            background: #1a3a2a;
            border-left: 3px solid #4a9d4a;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 10px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #8b9dc3;
        }

        .send-btn {
            background: #c73e1d;
            border: none;
            color: white;
            padding: 10px 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .send-btn:hover {
            background: #d84e2d;
        }

        .export-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            margin: 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-btn:hover {
            background: #8b9dc3;
            border-color: #8b9dc3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Linke Spalte - The Bible -->
        <div class="bible-panel">
            <h2>The Bible</h2>
            
            <div class="bible-section">
                <h3>Charaktere</h3>
                <button class="add-character-btn" id="addCharacterBtn">Neuer Charakter</button>
                <div class="character-cards" id="characterCards"></div>
            </div>
            
            <div class="bible-section">
                <h3>Drehorte</h3>
                <textarea class="bible-textarea" id="locations" placeholder="ORT&#10;Beschreibung:&#10;Atmosphäre:&#10;Bedeutung:"></textarea>
            </div>
            
            <div class="bible-section">
                <h3>Hintergründe</h3>
                <textarea class="bible-textarea" id="background" placeholder="WELT/ZEIT&#10;Regeln:&#10;Konflikte:&#10;Themen:"></textarea>
            </div>
        </div>
        
        <!-- Mittlere Spalte - The Script -->
        <div class="script-panel">
            <div class="script-header">
                <h2>The Script</h2>
            </div>
            <div class="script-editor">
                <textarea class="script-textarea" id="script" placeholder="FADE IN:

EXT. ORT - TAG

Eine Beschreibung der Szene.

                        CHARAKTER
            Dialogtext hier.

                        ANDERER CHARAKTER
            Antwort hier.

FADE OUT."></textarea>
            </div>
        </div>
        
        <!-- Rechte Spalte - The Dramaturg -->
        <div class="dramaturg-panel">
            <div class="dramaturg-header">
                <h2>Directorial Notes</h2>
                <div class="ollama-config">
                    <input type="text" class="ollama-url-input" id="ollamaUrlInput" placeholder="Ollama URL">
                    <button class="ollama-save-btn" id="saveOllamaUrl">Speichern</button>
                </div>
            </div>
            
            <div class="smart-actions">
                <button class="action-btn" id="analyzeScene">Szene analysieren</button>
                <button class="action-btn" id="dialogCheck">Dialog-Check</button>
                <button class="action-btn" id="continueWriting">Weiterschreiben</button>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        Willkommen bei der Director's Script Engine. Ich bin Ihr Script-Consultant und helfe Ihnen bei der Entwicklung Ihres Drehbuchs. Stellen Sie mir Fragen oder nutzen Sie die Smart Actions für gezielte Analysen.
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Frage an den Dramaturgen...">
                    <button class="send-btn" id="sendMessageBtn">Senden</button>
                </div>
            </div>
            
            <button class="export-btn" id="exportBtn">Arbeit exportieren</button>
        </div>
    </div>

    <script>
        // IndexedDB für Datenpersistenz
        const DB_NAME = 'DirectorsScriptEngine';
        const DB_VERSION = 1;
        let db;
        let characters = []; // Array für Charakter-Kacheln

        // IndexedDB initialisieren
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('scriptData')) {
                        db.createObjectStore('scriptData');
                    }
                };
            });
        }

        // Daten speichern
        async function saveData(key, data) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['scriptData'], 'readwrite');
                const store = transaction.objectStore('scriptData');
                const request = store.put(data, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Daten laden
        async function loadData(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['scriptData'], 'readonly');
                const store = transaction.objectStore('scriptData');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Alle Daten laden
        async function loadAllData() {
            const locations = await loadData('locations') || '';
            const background = await loadData('background') || '';
            const script = await loadData('script') || '';

            // Sicherheitsprüfungen für DOM-Elemente
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');
            const scriptElement = document.getElementById('script');

            if (locationsElement) locationsElement.value = locations;
            if (backgroundElement) backgroundElement.value = background;
            if (scriptElement) scriptElement.value = script;

            // Charakter-Kacheln laden (ersetzt das alte characters textarea)
            await loadCharacters();
        }

        // Charakter-Kacheln laden
        async function loadCharacters() {
            const savedCharacters = await loadData('characterCards') || [];
            characters = Array.isArray(savedCharacters) ? savedCharacters : [];
            renderAllCharacters();
        }

        // Charakter-Kacheln speichern
        async function saveCharacters() {
            await saveData('characterCards', characters);
        }

        // Charakter-Kachel erstellen
        function createCharacterCard(character, index) {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.dataset.index = index;

            card.innerHTML = `
                <div class="character-card-header">
                    <div class="character-name">${character.name}</div>
                    <div class="character-role">${character.role || 'Charakter'}</div>
                </div>
                <div class="character-summary">${character.summary || 'Keine Zusammenfassung verfügbar.'}</div>
                <div class="character-details">
                    <div class="character-detail-item">
                        <div class="character-detail-label">Alter</div>
                        <div class="character-detail-value">${character.age || 'Unbekannt'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Aussehen</div>
                        <div class="character-detail-value">${character.appearance || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Persönlichkeit</div>
                        <div class="character-detail-value">${character.personality || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Motivation</div>
                        <div class="character-detail-value">${character.motivation || 'Nicht beschrieben'}</div>
                    </div>
                    <div class="character-detail-item">
                        <div class="character-detail-label">Hintergrund</div>
                        <div class="character-detail-value">${character.background || 'Nicht beschrieben'}</div>
                    </div>
                </div>
                <div class="character-actions">
                    <button class="character-action-btn" onclick="deleteCharacter(${index})">×</button>
                </div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('character-action-btn')) {
                    toggleCharacterCard(card);
                }
            });

            return card;
        }

        // Alle Charakter-Kacheln rendern
        function renderAllCharacters() {
            const container = document.getElementById('characterCards');
            container.innerHTML = '';

            characters.forEach((character, index) => {
                const card = createCharacterCard(character, index);
                container.appendChild(card);
            });
        }

        // Charakter-Kachel expandieren/collapsen
        function toggleCharacterCard(card) {
            card.classList.toggle('expanded');
        }

        // Neuen Charakter hinzufügen
        function addCharacter(characterData = null) {
            const newCharacter = characterData || {
                name: 'Neuer Charakter',
                role: 'Charakter',
                age: '',
                appearance: '',
                personality: '',
                motivation: '',
                background: '',
                summary: 'Neuer Charakter ohne Beschreibung.'
            };

            characters.push(newCharacter);
            saveCharacters();
            renderAllCharacters();
        }

        // Charakter löschen
        window.deleteCharacter = function(index) {
            if (confirm('Charakter wirklich löschen?')) {
                characters.splice(index, 1);
                saveCharacters();
                renderAllCharacters();
            }
        };

        // Ollama-Antwort für Charakter parsen
        function parseCharacterFromResponse(response, requestedName = '') {
            const lines = response.split('\n').map(line => line.trim()).filter(line => line);

            const character = {
                name: requestedName || 'Unbenannter Charakter',
                role: 'Charakter',
                age: '',
                appearance: '',
                personality: '',
                motivation: '',
                background: '',
                summary: ''
            };

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();

                if (lowerLine.includes('name:') || lowerLine.includes('name')) {
                    character.name = line.split(':')[1]?.trim() || character.name;
                } else if (lowerLine.includes('alter:') || lowerLine.includes('age:')) {
                    character.age = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('aussehen:') || lowerLine.includes('appearance:')) {
                    character.appearance = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('persönlichkeit:') || lowerLine.includes('personality:')) {
                    character.personality = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('motivation:') || lowerLine.includes('motivation')) {
                    character.motivation = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('hintergrund:') || lowerLine.includes('background:')) {
                    character.background = line.split(':')[1]?.trim() || '';
                } else if (lowerLine.includes('rolle:') || lowerLine.includes('role:')) {
                    character.role = line.split(':')[1]?.trim() || 'Charakter';
                }
            });

            // Zusammenfassung erstellen
            character.summary = `${character.name} ist ${character.age ? character.age + ' Jahre alt' : 'im unbekannten Alter'}. ${character.personality ? character.personality : 'Persönlichkeit nicht beschrieben.'}`;

            return character;
        }

        // Auto-Save Funktion
        function setupAutoSave() {
            const elements = ['locations', 'background', 'script'];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        saveData(id, element.value);
                    });
                }
            });
        }

        // Ollama API Call - Konfigurierbare URL für lokale/dev und remote/production
        async function callOllama(prompt, context) {
            // URL konfigurierbar machen - standardmäßig localhost für Entwicklung
            const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434/api/generate';

            try {
                const response = await fetch(ollamaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama3.2',
                        prompt: `${context}\n\n${prompt}`,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Debug: Log the response to see its structure
                console.log('Ollama Response:', data);

                // Check if response exists and has the correct property
                if (data && data.response) {
                    return data.response;
                } else if (data && data.text) {
                    return data.text;
                } else if (data && typeof data === 'string') {
                    return data;
                } else {
                    console.error('Unexpected response format:', data);
                    return 'Unerwartetes Antwortformat von Ollama';
                }
            } catch (error) {
                console.error('Ollama API Error:', error);

                // Spezifische CORS/HTTPS-Fehlerbehandlung
                if (error.message.includes('CORS') || error.message.includes('Mixed Content')) {
                    return `CORS-Fehler: Die Website (HTTPS) kann nicht auf lokales Ollama (HTTP) zugreifen.\n\nLösungen:\n1. Ollama mit CORS starten: OLLAMA_ORIGINS=https://sohaltweil.de ollama serve\n2. Ollama auf HTTPS-Server hosten\n3. Browser-Einstellungen anpassen (unsichere Inhalte erlauben)\n\nTechnischer Fehler: ${error.message}`;
                }

                return `Fehler bei der Verbindung zu Ollama: ${error.message}\n\nStellen Sie sicher, dass:\n- Ollama läuft (${ollamaUrl})\n- Das Modell 'llama3.2' verfügbar ist\n- CORS für diese Domain erlaubt ist`;
            }
        }

        // Nachricht zum Chat hinzufügen
        function addMessage(text, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Smart Actions - Sicherheitsprüfungen für DOM-Elemente
        document.getElementById('analyzeScene').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');
            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';

            const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

            addMessage('Analysiere Szene...', true);

            const prompt = 'Analysiere diese Szene auf Pacing, Spannungsbogen und Subtext. Gib konstruktive Hinweise für die Regie.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        document.getElementById('dialogCheck').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');

            const context = `CHARACTERS:\n${charactersText}\n\nSCRIPT:\n${script}`;

            addMessage('Prüfe Dialoge...', true);

            const prompt = 'Prüfe, ob die Dialoge der Charaktere konsistent mit ihren beschriebenen Persönlichkeiten sind. Gib spezifische Hinweise für jeden Charakter.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        document.getElementById('continueWriting').addEventListener('click', async () => {
            const scriptElement = document.getElementById('script');
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');

            const script = scriptElement ? scriptElement.value : '';
            // Verwende Charakter-Kacheln statt textarea
            const charactersText = characters.map(char =>
                `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
            ).join('\n\n');
            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';

            const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

            addMessage('Schreibe weiter...', true);

            const prompt = 'Schlage die nächsten 5-10 Zeilen des Drehbuchs vor, die sich nahtlos an die letzte Szene anschließen. Halte dich an das Format und die Charaktere.';
            const response = await callOllama(prompt, context);

            addMessage(response);
        });

        // Chat-Funktionalität
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';

            // Prüfe auf Charakter-Erstellungsbefehle
            const characterMatch = message.match(/(erstelle|create).*steckbrief.*für\s+(.+)/i) ||
                                   message.match(/(erstelle|create).*(charakter|character).*\s+(.+)/i);

            if (characterMatch) {
                const characterName = characterMatch[2].trim();
                addMessage(`Erstelle Steckbrief für ${characterName}...`, false);

                const script = document.getElementById('script').value;
                const context = `SCRIPT:\n${script}\n\nErstelle einen detaillierten Steckbrief für den Charakter "${characterName}". Gib die Informationen in folgendem Format:\nName: [Name]\nAlter: [Alter]\nAussehen: [Beschreibung]\nPersönlichkeit: [Beschreibung]\nMotivation: [Beschreibung]\nHintergrund: [Beschreibung]\nRolle: [Protagonist/Antagonist/etc.]`;

                try {
                    const response = await callOllama(`Erstelle einen detaillierten Steckbrief für den Charakter "${characterName}" basierend auf dem Skript.`, context);
                    addMessage(`Steckbrief für ${characterName} erstellt!`, false);

                    // Parse die Antwort und erstelle eine Charakter-Kachel
                    const characterData = parseCharacterFromResponse(response, characterName);
                    addCharacter(characterData);

                    addMessage(`Charakter "${characterName}" wurde zur Bible hinzugefügt.`, false);
                } catch (error) {
                    addMessage(`Fehler beim Erstellen des Steckbriefs: ${error.message}`, false);
                }
            } else {
                // Normale Chat-Funktionalität
                const scriptElement = document.getElementById('script');
                const locationsElement = document.getElementById('locations');
                const backgroundElement = document.getElementById('background');

                const script = scriptElement ? scriptElement.value : '';
                // Verwende Charakter-Kacheln statt textarea
                const charactersText = characters.map(char =>
                    `${char.name}: ${char.summary}\nAlter: ${char.age}\nPersönlichkeit: ${char.personality}`
                ).join('\n\n');
                const locations = locationsElement ? locationsElement.value : '';
                const background = backgroundElement ? backgroundElement.value : '';

                const context = `SCRIPT:\n${script}\n\nCHARACTERS:\n${charactersText}\n\nLOCATIONS:\n${locations}\n\nBACKGROUND:\n${background}`;

                const response = await callOllama(message, context);
                addMessage(response);
            }
        });

        // Enter-Taste für Chat
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Export-Funktion
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const locationsElement = document.getElementById('locations');
            const backgroundElement = document.getElementById('background');
            const scriptElement = document.getElementById('script');

            const locations = locationsElement ? locationsElement.value : '';
            const background = backgroundElement ? backgroundElement.value : '';
            const script = scriptElement ? scriptElement.value : '';

            const exportData = {
                characterCards: characters, // Neue Charakter-Kacheln
                locations: locations,
                background: background,
                script: script,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `script-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            addMessage('Arbeit wurde als JSON exportiert.', false);
        });

        // Ollama URL Konfiguration
        document.getElementById('saveOllamaUrl').addEventListener('click', () => {
            const url = document.getElementById('ollamaUrlInput').value.trim();
            if (url) {
                localStorage.setItem('ollamaUrl', url);
                addMessage(`Ollama URL gespeichert: ${url}`, false);
                document.getElementById('ollamaUrlInput').value = '';
            } else {
                addMessage('Bitte geben Sie eine gültige URL ein.', false);
            }
        });

        // Neuer Charakter Button
        document.getElementById('addCharacterBtn').addEventListener('click', () => {
            addCharacter();
            addMessage('Neuer Charakter wurde zur Bible hinzugefügt.', false);
        });

        // URL Eingabe beim Laden mit aktueller URL füllen
        window.addEventListener('load', async () => {
            await initDB();
            await loadAllData();
            setupAutoSave();

            // Aktuelle Ollama URL anzeigen
            const currentUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434/api/generate';
            document.getElementById('ollamaUrlInput').placeholder = `Aktuell: ${currentUrl}`;
        });
    </script>
</body>
</html>
